<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KanBanProj</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: "Inter", "Segoe UI", Arial, sans-serif;
            background: #f4f5f7;
            margin: 0;
            padding: 20px;
        }

        .container {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            overflow-x: auto;
            overflow-y: hidden;
            height: calc(100vh - 40px);
            padding-bottom: 20px;
        }

        .task-column {
            background: #ebecf0;
            border-radius: 8px;
            padding: 12px;
            width: 280px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            cursor: grab;
        }
        
        .task-column.dragging-column {
            opacity: 0.5;
            transform: rotate(1deg);
        }

        .row {
            min-height: 50px;
            border: 1px solid #ccc;
            padding: 10px;
            display: flex;
            gap: 10px;
        }

        .row.placeholder {
            background-color: #eee; 
            border: 2px dashed #aaa;
            transition: background-color 0.2s, border 0.2s;
        } 

        .row:after {
            content: "";
            display: table;
            clear: both;
        }

        @media screen and (max-width: 600px) {
        .column {
            width: 100%;
            display: block;
            margin-bottom: 20px;
        }
        }

        .card {
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
            padding: 16px;
            text-align: center;
            background-color: #f1f1f1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Le contenu du tableau sera généré ici par JS -->
    </div>

    <script>
        // --- Données initiales par défaut ---
        const defaultData = {
            "cards": {
                "0": { "task": "lire le cours d'HTML", "due": "2025-11-20", "color": "#ffffff" },
                "1": { "task": "faire les exercices CSS", "due": "2025-11-22", "color": "#ffffff" },
                "2": { "task": "réviser JavaScript (DOM)", "due": "2025-11-25", "color": "#ffffff" },
                "3": { "task": "créer un mini-projet HTML/CSS", "due": "2025-11-28", "color": "#e6fffa" }
            },
            "table": {
                "0": { "name": "TO-DO", "cards": ["0", "1"] },
                "1": { "name": "IN-PROGRESS", "cards": ["2"] },
                "2": { "name": "DONE", "cards": ["3"] }
            },
            "columnOrder": ["0", "1", "2"]
        };

        // --- Chargement des données ---
        // On essaie de récupérer les données du LocalStorage, sinon on utilise les défauts
        let boardData = JSON.parse(localStorage.getItem('kanbanBoardData')) || defaultData;

        // Migration : s'assurer que columnOrder existe (pour les anciennes sauvegardes)
        if (!boardData.columnOrder) {
            boardData.columnOrder = Object.keys(boardData.table);
        }

        // --- Fonction de sauvegarde ---
        function saveBoard() {
            localStorage.setItem('kanbanBoardData', JSON.stringify(boardData));
        }

        // --- Validation de la date ---
        function isValidDate(dateString) {
            const regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!regex.test(dateString)) return false;
            const date = new Date(dateString);
            // Vérifie si c'est une date valide et si la chaîne correspond à la partie date ISO
            return date instanceof Date && !isNaN(date) && date.toISOString().slice(0,10) === dateString;
        }

        // --- Actions (Suppression, Édition) ---

        // Supprimer une colonne (liste)
        function deleteColumn(colId) {
            if (confirm("Êtes-vous sûr de vouloir supprimer cette liste et toutes ses tâches ?")) {
                // Nettoyage des cartes orphelines
                boardData.table[colId].cards.forEach(cardId => {
                    delete boardData.cards[cardId];
                });
                // Suppression de la colonne
                delete boardData.table[colId];
                // Mise à jour de l'ordre
                boardData.columnOrder = boardData.columnOrder.filter(id => id !== colId);
                
                saveBoard();
                renderBoard(boardData);
            }
        }

        // Supprimer une tâche
        function deleteTask(colId, taskId) {
            if (confirm("Supprimer cette tâche ?")) {
                boardData.table[colId].cards = boardData.table[colId].cards.filter(id => id !== taskId);
                delete boardData.cards[taskId];
                saveBoard();
                renderBoard(boardData);
            }
        }

        // Éditer le nom d'une colonne
        function editColumn(colId) {
            const currentName = boardData.table[colId].name;
            const newName = prompt("Entrez le nouveau titre de la liste :", currentName);
            if (newName && newName.trim() !== "") {
                boardData.table[colId].name = newName;
                saveBoard();
                renderBoard(boardData);
            }
        }

        // Éditer une tâche (Nom et Date)
        function editTask(cardId) {
            const card = boardData.cards[cardId];
            const newTask = prompt("Modifier la description :", card.task);
            if (newTask === null) return; // Annulé
            
            const newDue = prompt("Modifier la date d'échéance (AAAA-MM-JJ) :", card.due);
            if (newDue === null) return; // Annulé

            // Validation de la date
            if (newDue !== "" && !isValidDate(newDue)) {
                alert("Format de date invalide. Veuillez utiliser AAAA-MM-JJ.");
                return;
            }

            if (newTask || newDue) {
                boardData.cards[cardId] = {
                    ...card,
                    task: newTask || card.task,
                    due: newDue || card.due
                };
                saveBoard();
                renderBoard(boardData);
            }
        }

        // Changer la couleur d'une tâche
        function changeTaskColor(cardId, newColor) {
            if (boardData.cards[cardId]) {
                boardData.cards[cardId].color = newColor;
                saveBoard();
                // Pas besoin de tout re-rendre, on peut juste appliquer le style si on veut optimiser,
                // mais renderBoard est plus sûr pour la cohérence.
                renderBoard(boardData);
            }
        }

        // --- Fonction de Rendu Principal ---

        function renderBoard(data) {
            const container = document.querySelector(".container");
            container.innerHTML = "";

            // Boucle sur les colonnes selon l'ordre défini
            data.columnOrder.forEach((colId) => {
                const colData = data.table[colId];
                if (!colData) return;

                const column = document.createElement("div");
                column.className = "task-column";
                column.draggable = true; // Rend la colonne déplaçable
                column.dataset.id = colId;

        document.addEventListener("dragover", (ev) => {
            const row = ev.target.closest(".row");
            if (row) {
                ev.preventDefault(); // allow drop
                row.classList.add("placeholder"); // show grey area
            }
        });

        document.addEventListener("dragleave", (ev) => {
            const row = ev.target.closest(".row");
            if (row) {
                row.classList.remove("placeholder"); // remove grey when leaving
            }
        });

        document.addEventListener("drop", (ev) => {
            const row = ev.target.closest(".row");
            if (row) {
                ev.preventDefault();
                row.classList.remove("placeholder"); // remove grey
                row.append(draggedEl.parentNode);    // move card
            }
        });
    </script>
</body>
</html>